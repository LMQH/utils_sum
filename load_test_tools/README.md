# è´Ÿè½½æµ‹è¯•å·¥å…·

ä¸€ä¸ªåŸºäº Python çš„å¼‚æ­¥ HTTP è´Ÿè½½æµ‹è¯•å·¥å…·ï¼Œç”¨äºæµ‹è¯• API æ¥å£çš„æ€§èƒ½å’Œç¨³å®šæ€§ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸš€ **å¼‚æ­¥å¹¶å‘**ï¼šåŸºäº `aiohttp` å®ç°é«˜å¹¶å‘å¼‚æ­¥è¯·æ±‚
- ğŸ“Š **ä¸‰æ¡£åˆ†ç±»ç»Ÿè®¡**ï¼šæ ¹æ®å“åº”æ—¶é—´è‡ªåŠ¨åˆ†ç±»ä¸º fast/slow/bad
- ğŸ“ˆ **æ‰¹é‡æµ‹è¯•**ï¼šæ”¯æŒæ‰¹é‡æµ‹è¯•ä¸åŒå¹¶å‘æ•°ï¼Œè‡ªåŠ¨ç”Ÿæˆå¯¹æ¯”æŠ¥å‘Š
- ğŸ“ **è¯¦ç»†æŠ¥å‘Š**ï¼šç”Ÿæˆæ–‡æœ¬å’Œ JSON æ ¼å¼çš„æµ‹è¯•æŠ¥å‘Š
- âš™ï¸ **çµæ´»é…ç½®**ï¼šæ”¯æŒé…ç½®æ–‡ä»¶ã€å‘½ä»¤è¡Œå‚æ•°å’Œä»£ç é…ç½®
- ğŸ¯ **å¤šé˜¶æ®µæµ‹è¯•**ï¼šæä¾›é¢„è®¾çš„æµ‹è¯•é˜¶æ®µè„šæœ¬ï¼ˆåŸºå‡†æµ‹è¯•ã€å¢é•¿æµ‹è¯•ã€å‹åŠ›æµ‹è¯•ç­‰ï¼‰

## é¡¹ç›®ç»“æ„

```
load_test/
â”œâ”€â”€ core/                      # æ ¸å¿ƒåŠŸèƒ½æ¨¡å—
â”‚   â”œâ”€â”€ load_test_core.py     # æ ¸å¿ƒæµ‹è¯•å¼•æ“ï¼ˆè¯·æ±‚å‘é€ã€ç»“æœç»Ÿè®¡ï¼‰
â”‚   â”œâ”€â”€ load_test_runner.py   # æµ‹è¯•è¿è¡Œå™¨ï¼ˆå•æ¬¡/æ‰¹é‡/åºåˆ—æµ‹è¯•ï¼‰
â”‚   â”œâ”€â”€ load_test_reporter.py # æŠ¥å‘Šç”Ÿæˆå™¨
â”‚   â””â”€â”€ load_test_config.py   # é…ç½®ç®¡ç†
â”œâ”€â”€ test_scripts/              # æµ‹è¯•è„šæœ¬
â”‚   â”œâ”€â”€ stage1_baseline_test.py      # é˜¶æ®µ1ï¼šåŸºå‡†æµ‹è¯•
â”‚   â”œâ”€â”€ stage2_rampup_test.py        # é˜¶æ®µ2ï¼šçº¿æ€§å¢é•¿æµ‹è¯•
â”‚   â”œâ”€â”€ stage3_inflection_test.py    # é˜¶æ®µ3ï¼šæ‹ç‚¹æµ‹è¯•
â”‚   â”œâ”€â”€ stage4_stress_test.py        # é˜¶æ®µ4ï¼šå‹åŠ›æµ‹è¯•
â”‚   â”œâ”€â”€ stage5_stability_test.py     # é˜¶æ®µ5ï¼šç¨³å®šæ€§æµ‹è¯•
â”‚   â””â”€â”€ custom_config_test.py        # è‡ªå®šä¹‰é…ç½®æµ‹è¯•
â”œâ”€â”€ reports/                   # æµ‹è¯•æŠ¥å‘Šè¾“å‡ºç›®å½•
â”‚   â”œâ”€â”€ stage1/               # é˜¶æ®µ1æŠ¥å‘Š
â”‚   â”œâ”€â”€ stage2/               # é˜¶æ®µ2æŠ¥å‘Š
â”‚   â”œâ”€â”€ stage3/               # é˜¶æ®µ3æŠ¥å‘Š
â”‚   â”œâ”€â”€ stage4/               # é˜¶æ®µ4æŠ¥å‘Š
â”‚   â”œâ”€â”€ stage5/               # é˜¶æ®µ5æŠ¥å‘Š
â”‚   â””â”€â”€ custom/               # è‡ªå®šä¹‰æµ‹è¯•æŠ¥å‘Š
â”œâ”€â”€ load_test_config.json     # é…ç½®æ–‡ä»¶
â”œâ”€â”€ requirements.txt          # ä¾èµ–æ–‡ä»¶
â””â”€â”€ README.md                 # è¯´æ˜æ–‡æ¡£
```

## å®‰è£…ä¾èµ–

```bash
pip install -r requirements.txt
```

## å¿«é€Ÿå¼€å§‹

### æ–¹å¼ä¸€ï¼šä½¿ç”¨é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

1. ç¼–è¾‘ `load_test_config.json` é…ç½®æ–‡ä»¶
2. è¿è¡Œè‡ªå®šä¹‰é…ç½®æµ‹è¯•ï¼š

```bash
python test_scripts/custom_config_test.py
```

### æ–¹å¼äºŒï¼šä½¿ç”¨é¢„è®¾æµ‹è¯•è„šæœ¬

è¿è¡Œä¸åŒé˜¶æ®µçš„æµ‹è¯•ï¼š

```bash
# é˜¶æ®µ1ï¼šåŸºå‡†æµ‹è¯•ï¼ˆä½å¹¶å‘ï¼‰
python test_scripts/stage1_baseline_test.py

# é˜¶æ®µ2ï¼šçº¿æ€§å¢é•¿æµ‹è¯•
python test_scripts/stage2_rampup_test.py

# é˜¶æ®µ3ï¼šæ‹ç‚¹æµ‹è¯•
python test_scripts/stage3_inflection_test.py

# é˜¶æ®µ4ï¼šå‹åŠ›æµ‹è¯•
python test_scripts/stage4_stress_test.py

# é˜¶æ®µ5ï¼šç¨³å®šæ€§æµ‹è¯•
python test_scripts/stage5_stability_test.py
```

## é…ç½®æ–‡ä»¶è¯´æ˜

`load_test_config.json` é…ç½®æ–‡ä»¶æ”¯æŒä»¥ä¸‹å‚æ•°ï¼š

| å‚æ•° | ç±»å‹ | è¯´æ˜ | é»˜è®¤å€¼ |
|------|------|------|--------|
| `url` | string | API æ¥å£åœ°å€ï¼ˆå¿…éœ€ï¼‰ | - |
| `concurrent` | int/array | å¹¶å‘æ•°ã€‚æ”¯æŒæ•°ç»„æ ¼å¼å¯ç”¨æ‰¹é‡æµ‹è¯• | 10 |
| `total` | int/array/null | æ€»è¯·æ±‚æ•°ï¼ˆä¸ duration äºŒé€‰ä¸€ï¼‰ | null |
| `duration` | int/array/null | æµ‹è¯•æŒç»­æ—¶é—´ï¼Œå•ä½ç§’ï¼ˆä¸ total äºŒé€‰ä¸€ï¼‰ | null |
| `content` | string | è¯·æ±‚å†…å®¹ | ç¤ºä¾‹åœ°å€ |
| `timeout` | int | è¯·æ±‚è¶…æ—¶æ—¶é—´ï¼Œå•ä½ç§’ | 5 |
| `t1` | float | å¿«é€Ÿè¯·æ±‚é˜ˆå€¼ï¼Œå•ä½ç§’ã€‚å“åº”æ—¶é—´ < T1 å½’ç±»ä¸º fast | 1.0 |
| `t2` | float | æ…¢é€Ÿè¯·æ±‚é˜ˆå€¼ï¼Œå•ä½ç§’ã€‚T1 â‰¤ å“åº”æ—¶é—´ â‰¤ T2 å½’ç±»ä¸º slowï¼Œ> T2 å½’ç±»ä¸º bad | 3.0 |
| `output_dir` | string | æŠ¥å‘Šä¿å­˜ç›®å½• | test/load_test/reports |
| `json` | boolean | æ˜¯å¦åŒæ—¶ä¿å­˜ JSON æ ¼å¼æŠ¥å‘Š | false |
| `batch_mode.cooldown` | int | æ‰¹é‡æµ‹è¯•æ—¶ï¼Œæ¯æ¬¡æµ‹è¯•ä¹‹é—´çš„å†·å´æ—¶é—´ï¼Œå•ä½ç§’ | 5 |

### æ‰¹é‡æµ‹è¯•æ¨¡å¼

å°† `concurrent`ã€`total` æˆ– `duration` è®¾ç½®ä¸ºæ•°ç»„æ ¼å¼ï¼Œå³å¯å¯ç”¨æ‰¹é‡æµ‹è¯•æ¨¡å¼ï¼š

```json
{
  "url": "https://api.example.com/test",
  "concurrent": [1, 5, 10, 20, 50],
  "total": 100
}
```

è¿™å°†ä¾æ¬¡æµ‹è¯•å¹¶å‘æ•°ä¸º 1ã€5ã€10ã€20ã€50 çš„æƒ…å†µï¼Œå¹¶ç”Ÿæˆæ±‡æ€»å¯¹æ¯”æŠ¥å‘Šã€‚

## ä¸‰æ¡£åˆ†ç±»ç»Ÿè®¡

æµ‹è¯•ç»“æœä¼šæ ¹æ®å“åº”æ—¶é—´è‡ªåŠ¨åˆ†ç±»ï¼š

- **Fastï¼ˆå¿«é€Ÿè¯·æ±‚ï¼‰**ï¼šå“åº”æ—¶é—´ < T1ï¼ˆé»˜è®¤ 1 ç§’ï¼‰
- **Slowï¼ˆæ…¢é€Ÿè¯·æ±‚ï¼‰**ï¼šT1 â‰¤ å“åº”æ—¶é—´ â‰¤ T2ï¼ˆé»˜è®¤ 1-3 ç§’ï¼‰
- **Badï¼ˆåè¯·æ±‚ï¼‰**ï¼šå“åº”æ—¶é—´ > T2ï¼ˆé»˜è®¤ > 3 ç§’ï¼‰æˆ–è¯·æ±‚å¤±è´¥/è¶…æ—¶

## æµ‹è¯•æŠ¥å‘Š

æµ‹è¯•å®Œæˆåï¼Œä¼šåœ¨ `reports/` ç›®å½•ä¸‹ç”Ÿæˆè¯¦ç»†çš„æµ‹è¯•æŠ¥å‘Šï¼ŒåŒ…æ‹¬ï¼š

### æ–‡æœ¬æŠ¥å‘Šå†…å®¹

- æµ‹è¯•é…ç½®ä¿¡æ¯
- è¯·æ±‚ç»Ÿè®¡ï¼ˆä¸‰æ¡£åˆ†ç±»ï¼‰
- æ€§èƒ½ç»Ÿè®¡ï¼ˆQPSã€æµ‹è¯•æ—¶é•¿ï¼‰
- å“åº”æ—¶é—´ç»Ÿè®¡ï¼ˆæœ€å°å€¼ã€æœ€å¤§å€¼ã€å¹³å‡å€¼ã€ä¸­ä½æ•°ã€P50/P90/P95/P99ï¼‰
- HTTP çŠ¶æ€ç ç»Ÿè®¡
- é”™è¯¯ä¿¡æ¯ï¼ˆå¦‚æœ‰ï¼‰

### æ‰¹é‡æµ‹è¯•æ±‡æ€»æŠ¥å‘Š

æ‰¹é‡æµ‹è¯•æ¨¡å¼ä¸‹ï¼Œä¼šé¢å¤–ç”Ÿæˆæ±‡æ€»æŠ¥å‘Šï¼ŒåŒ…å«ï¼š

- æ€§èƒ½å¯¹æ¯”è¡¨
- QPS å³°å€¼åˆ†æ
- æ¨èé…ç½®å»ºè®®
- å“åº”æ—¶é—´è¶‹åŠ¿åˆ†æ
- æ€§èƒ½æ‹ç‚¹è¯†åˆ«

## ç¼–ç¨‹æ¥å£

### å•æ¬¡æµ‹è¯•

```python
from core.load_test_runner import run_single_test

result = await run_single_test(
    url='https://api.example.com/test',
    concurrent=10,
    total=100,
    payload={"Content": "æµ‹è¯•å†…å®¹"},
    timeout=5,
    t1=1.0,
    t2=3.0,
    output_dir='reports',
    save_json=False
)

# è·å–ç»Ÿè®¡ä¿¡æ¯
stats = result.get_statistics()
print(f"QPS: {stats['qps']:.2f}")
print(f"Fastç‡: {stats['fast_rate']:.2f}%")
```

### æ‰¹é‡æµ‹è¯•

```python
from core.load_test_runner import run_sequential_tests

test_configs = [
    {'concurrent': 10, 'total': 100},
    {'concurrent': 20, 'total': 100},
    {'concurrent': 30, 'total': 100},
]

base_config = {
    'url': 'https://api.example.com/test',
    'timeout': 5,
    't1': 1.0,
    't2': 3.0,
    'content': "æµ‹è¯•å†…å®¹"
}

results = await run_sequential_tests(
    test_configs=test_configs,
    base_config=base_config,
    output_dir='reports/stage1',
    save_json=False,
    cooldown=5,
    generate_summary=True
)
```

## æµ‹è¯•é˜¶æ®µè¯´æ˜

### é˜¶æ®µ1ï¼šåŸºå‡†æµ‹è¯•
- **ç›®æ ‡**ï¼šè·å–å•è¯·æ±‚æœ€ä¼˜æ€§èƒ½ï¼Œæµ‹è¯•ä½å¹¶å‘ä¸‹çš„è¡¨ç°
- **é…ç½®**ï¼šå¹¶å‘æ•° 1-5ï¼Œå„ 100 è¯·æ±‚

### é˜¶æ®µ2ï¼šçº¿æ€§å¢é•¿æµ‹è¯•
- **ç›®æ ‡**ï¼šå¯»æ‰¾æ€§èƒ½æ‹ç‚¹
- **é…ç½®**ï¼šæ¯ 30 ç§’å¢åŠ  10 å¹¶å‘

### é˜¶æ®µ3ï¼šæ‹ç‚¹æµ‹è¯•
- **ç›®æ ‡**ï¼šç²¾ç¡®å®šä½æ€§èƒ½æ‹ç‚¹
- **é…ç½®**ï¼šåœ¨æ‹ç‚¹é™„è¿‘è¿›è¡Œå¯†é›†æµ‹è¯•

### é˜¶æ®µ4ï¼šå‹åŠ›æµ‹è¯•
- **ç›®æ ‡**ï¼šæµ‹è¯•ç³»ç»Ÿæé™æ€§èƒ½
- **é…ç½®**ï¼šé«˜å¹¶å‘ã€é•¿æ—¶é—´è¿è¡Œ

### é˜¶æ®µ5ï¼šç¨³å®šæ€§æµ‹è¯•
- **ç›®æ ‡**ï¼šæµ‹è¯•ç³»ç»Ÿåœ¨æŒç»­è´Ÿè½½ä¸‹çš„ç¨³å®šæ€§
- **é…ç½®**ï¼šä¸­ç­‰å¹¶å‘ã€é•¿æ—¶é—´è¿è¡Œ

## æ³¨æ„äº‹é¡¹

1. **å¹¶å‘æ•°è®¾ç½®**ï¼šæ ¹æ®ç›®æ ‡æœåŠ¡å™¨æ€§èƒ½åˆç†è®¾ç½®å¹¶å‘æ•°ï¼Œé¿å…è¿‡åº¦å‹æµ‹
2. **è¶…æ—¶æ—¶é—´**ï¼šæ ¹æ® API å®é™…å“åº”æ—¶é—´è®¾ç½®åˆé€‚çš„è¶…æ—¶æ—¶é—´
3. **å†·å´æ—¶é—´**ï¼šæ‰¹é‡æµ‹è¯•æ—¶å»ºè®®è®¾ç½®é€‚å½“çš„å†·å´æ—¶é—´ï¼Œé¿å…å¯¹æœåŠ¡å™¨é€ æˆè¿‡å¤§å‹åŠ›
4. **ç½‘ç»œç¯å¢ƒ**ï¼šç¡®ä¿æµ‹è¯•ç¯å¢ƒç½‘ç»œç¨³å®šï¼Œé¿å…ç½‘ç»œé—®é¢˜å½±å“æµ‹è¯•ç»“æœ
